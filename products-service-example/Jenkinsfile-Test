pipeline {
    agent any
    stages {
        stage("Init") {
            steps {
                script {
                    comandossh = "ssh -i /var/jenkins_home/keyssh-devops-curso.pem ec2-user@172.31.25.112 sudo "
                    branchName = env.BRANCH_NAME
                    gitCredentials = "CREDENTIAL_ID"
                    repoUrl = "https://github.com/devopsort/products-service-example.git"
                    //test = load load ("/var/jenkins_home/workspace/products-service-example_Test/products-service-example/script.groovy")
                }
            }
        }

        stage('CloneRepo') {
            steps {
                echo 'Pulling...' + branchName
                checkout scm
            
            }
        }

        stage("Build") {
            steps {
                echo "-------------------------------------------------------------------"
                sh "${comandossh} 'docker build --build-arg JAR_FILE=products-service-example.jar -t 127.0.0.1:5000/products-service:${branchName}'"
            }
        }

        stage("Deploy in Test env") {
            steps {
                sh "${comandossh} 'docker run -d --name products-service-${branchName} -p 81:8080  127.0.0.1:5000/products-service:${branchName}'"
            }
        }
    }
}